![áº£nh](https://hackmd.io/_uploads/S17Nc1A5A.png)

ÄÃ¢y lÃ  má»™t bÃ i lab PortSwigger vá» khai thÃ¡c Web Cache Deception (táº¡m dá»‹ch lÃ  Ä‘Ã¡nh lá»«a cache lÆ°u trá»¯ ná»™i dung web)
[Link Here](https://portswigger.net/web-security/web-cache-deception/lab-wcd-exploiting-path-mapping).

## Tá»•ng quan vá» lÃ½ thuyáº¿t Web Cache
### Web Cache
Web Cache lÃ  má»™t há»‡ thá»‘ng náº±m giá»¯a Web Server vÃ  Client. Má»¥c Ä‘Ã­ch lÃ m tÄƒng tá»‘c vÃ  tá»‘i Æ°u hÃ³a tráº£i nghiá»‡m Web, hoáº¡t Ä‘á»™ng báº±ng cÃ¡ch lÆ°u trá»¯ táº¡m thá»i cÃ¡c báº£n sao cá»§a ná»™i dung web (nhÆ° hÃ¬nh áº£nh, tá»‡p CSS, Js,...) trÃªn cÃ¡c mÃ¡y chá»§ hoáº·c thiáº¿t bá»‹ (CDN server) gáº§n ngÆ°á»i dÃ¹ng hÆ¡n, giÃºp giáº£m thá»i gian load  vÃ  truy cáº­p ná»™i dung nhanh hÆ¡n.
![caching](https://hackmd.io/_uploads/ry6vAJAqR.svg)
VÃ­ dá»¥ , khi ngÆ°á»i dÃ¹ng yÃªu cáº§u má»™t ná»™i dung static resource (blog content) , Ä‘áº§u tiÃªn ,browser sáº½ request tá»›i Web Server láº¥y ná»™i dung, lÆ°u láº¡i á»Ÿ Cache server , rá»“i tráº£ vá» client. Trong cÃ¡c láº§n request tiáº¿p theo , thay vÃ¬ request trá»±c tiáº¿p lÃªn Web Server , browser sáº½ request Ä‘áº¿n Cache server láº¥y ná»™i dung rá»“i tráº£ vá» Client. Do do giáº£m táº£i cho Web server vÃ  cáº£i thiá»‡n tráº£i nghiá»‡m duyá»‡t web.  

### Web Cache Deception
Web Cache Deception lÃ  má»™t lá»— há»•ng cho phÃ©p káº» táº¥n cÃ´ng lá»«a bá»™ Ä‘á»‡m web lÆ°u trá»¯ ná»™i dung Ä‘á»™ng, nháº¡y cáº£m. NguyÃªn nhÃ¢n do sá»± khÃ¡c biá»‡t giá»¯a cÃ¡ch mÃ¡y chá»§ bá»™ Ä‘á»‡m vÃ  mÃ¡y chá»§ gá»‘c xá»­ lÃ½ cÃ¡c yÃªu cáº§u (giá»¯a Traditional URL mapping vÃ  RESTful URL mapping). Chi tiáº¿t xem [táº¡i Ä‘Ã¢y](https://portswigger.net/web-security/web-cache-deception).
![áº£nh](https://hackmd.io/_uploads/HyC7MgR9A.png)
![áº£nh](https://hackmd.io/_uploads/HyTvfeA9A.png)

VÃ­ dá»¥ , khi ngÆ°á»i dÃ¹ng request má»™t ná»™i dung khÃ´ng tá»“n táº¡i `(a.js)` tá»« path `/profile;a.js` 
(/profile chá»©a thÃ´ng tin ngÆ°á»i dÃ¹ng). MÃ¡y chá»§ web náº¿u Ä‘Æ°á»£c cáº¥u hÃ¬nh khÃ´ng Ä‘Ãºng , sáº½ tráº£ vá» toÃ n bá»™ ná»™i dung cá»§a /profile (chá»©a thÃ´ng tin ngÆ°á»i dÃ¹ng). Do cÃ¡c Cache server thÆ°á»ng lÆ°u cÃ¡c ná»™i dung cÃ³ extension lÃ  `.js` , `.css`, ... Do Ä‘Ã³ ,ná»™i dung tá»« `/profile` Ä‘Æ°á»£c lÆ°u á»Ÿ Cache Server vá»›i `key-url=.../profile;a.js`. Káº» táº¥n cÃ´ng lÃºc nÃ y chá»‰ cáº§n truy cáº­p `url=.../profile;a.js` lÃ  cÃ³ thá»ƒ láº¥y Ä‘Æ°á»£c thÃ´ng tin ngÆ°á»i dÃ¹ng.

![wcd-image-1](https://hackmd.io/_uploads/r1pCo1C50.png)

## Khai thÃ¡c lá»— há»•ng Web Cache Deception
Giáº£i thÃ­ch cÃ³ váº» dÃ i vÃ  khÃ³ hiá»ƒu ğŸ« , nÃªn lÃ  mÃ¬nh sáº½ trÃ¬nh bÃ y chi tiáº¿t vá»›i viá»‡c solve bÃ i lab cá»§a PortSwigger , link Ä‘Ã£ Ä‘á»ƒ á»Ÿ trÃªn. 

### Recon
![áº£nh](https://hackmd.io/_uploads/S1xY8xR5C.png)

Truy cáº­p trang lab , cÃ³ chá»©c nÄƒng login , enter vá»›i `username` vÃ  `password` Ä‘Æ°á»£c cung cáº¥p `(wiener:peter)` , ta redirect tá»›i path `/my-account`, á»Ÿ Ä‘Ã¢y xem Ä‘Æ°á»£c API cá»§a ngÆ°á»i dÃ¹ng: 
![áº£nh](https://hackmd.io/_uploads/rkMZDgAcA.png)

YÃªu cáº§u Ä‘á» bÃ i lÃ  tÃ¬m API Key cá»§a ngÆ°á»i dÃ¹ng `Carlos` .Ta test thá»­ vá»›i path `/my-account/hehe.js` Ä‘á»ƒ xem pháº£n há»“i web server: 
![áº£nh](https://hackmd.io/_uploads/S1VzOxRc0.png)

Sau khi enter , ná»™i dung tráº£ vá» váº«n chá»©a ná»™i dung `/my-account `, Ä‘iá»u nÃ y lÃ  do file `hehe.js` khÃ´ng tÃ¬m tháº¥y trÃªn mÃ¡y chá»§ web , nÃªn web server sáº½ trá»«u tÆ°á»£ng (abstract) path `/my-account/hehe.js` thÃ nh `/my-account/`. 
![áº£nh](https://hackmd.io/_uploads/BkJUdeAc0.png)

### Exploit
Intercept láº¡i request báº±ng Burpsuite:
![áº£nh](https://hackmd.io/_uploads/r13BqgRcA.png)

CÃ³ header `X-Cache: hit `, chá»©ng tá» ná»™i dung Ä‘Æ°á»£c lÆ°u vÃ  tráº£ vá» tá»« Cache , thá»­ báº­t tap private vÃ  test Ä‘Æ°á»£c dáº«n sau : .../my-account/hehe.js :  
![áº£nh](https://hackmd.io/_uploads/HJ_VolA90.png)

Ta thu Ä‘Æ°á»£c thÃ´ng tin ngÆ°á»i dÃ¹ng Ä‘Æ°á»£c tráº£ vá» khi truy cáº­p Ä‘Æ°á»ng dáº«n trÃªn mÃ  khÃ´ng cáº§n Ä‘Äƒng nháº­p ==> trang web dÃ­nh Web Cache Deception.

Ká»‹ch báº£n khai thÃ¡c: Káº» táº¥n cÃ´ng táº¡o má»™t URL request má»™t ná»™i dung khÃ´ng tá»“n táº¡i (/my-account/non-exist.js), vÃ  lá»«a ngÆ°á»i dÃ¹ng thá»±c hiá»‡n Ä‘Äƒng nháº­p , khi ngÆ°á»i dÃ¹ng truy cáº­p URL trÃªn , ná»™i dung /my-account Ä‘Æ°á»£c lÆ°u trá»¯ á»Ÿ Cache Server vá»›i `Cache-key` lÃ  URL Ä‘Ã³,  vÃ  káº» táº¥n cÃ´ng cÃ³ thá»ƒ truy cáº­p cÃ¹ng URL trÃªn Ä‘á»ƒ xem Ä‘á»±á»£c thÃ´ng tin ngÆ°á»i dÃ¹ng. 

## Kháº¯c phá»¥c
- LuÃ´n sá»­ dá»¥ng tiÃªu Ä‘á» `Cache-Control` Ä‘á»ƒ Ä‘Ã¡nh dáº¥u cÃ¡c Dynamic resource,  thiáº¿t láº­p báº±ng cÃ¡c giÃ¡ trá»‹ `no-store` vÃ  `private`.
- Cáº¥u hÃ¬nh CDN server cÃ¡c quy táº¯c lÆ°u trá»¯ Cache khÃ´ng ghi Ä‘Ã¨ lÃªn tiÃªu Ä‘á» `Cache-Control`.
- Äáº£m báº£o khÃ´ng cÃ³ sá»± khÃ¡c biá»‡t giá»¯a cÃ¡ch mÃ¡y chá»§ Web vÃ  Cache server diá»…n giáº£i Ä‘Æ°á»ng dáº«n URL.

## Tá»•ng káº¿t
LÃ¢u lÃ¢u khÃ´ng viáº¿t write-up nÃªn bÃ i nÃ y viáº¿t Ä‘áº§n quÃ¡, hiá»ƒu mÃ  khÃ´ng biáº¿t diá»…n táº£ sao cho Ä‘ÃºngğŸ« ğŸ« ğŸ«  
